name: Docker Build and Push CPA

on:
  workflow_dispatch:
    inputs:
      cpa_plus_version:
        description: "CLIProxyAPIPlus 版本, 留空自动获取最新版"
        required: false
        type: string

      cpa_version:
        description: "CLIProxyAPI 版本, 留空自动获取最新版"
        required: false
        type: string

      architecture:
        description: "构建哪个架构的镜像, 留空则构建 amd64+arm64 多架构"
        required: false
        type: choice
        options:
          - ""
          - "linux/amd64"
          - "linux/arm64"

      rebuild_strategy:
        description: "当 GHCR 中已存在该版本时的处理策略"
        required: true
        type: choice
        options:
          - "force"
          - "skip"

env:
  REGISTRY: ghcr.io
  CPA_REPO: router-for-me/CLIProxyAPI
  CPA_PLUS_REPO: router-for-me/CLIProxyAPIPlus

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self repo
        uses: actions/checkout@v4

      ###########################################################################
      # 生成 entrypoint.sh 和 Dockerfile
      ###########################################################################
      - name: Generate entrypoint.sh and Dockerfile
        run: |
          cat > entrypoint.sh << 'EOF'
          #!/bin/sh
          set -e

          # 初始化配置文件到挂载卷
          if [ ! -f /app/datas/config.yaml ]; then
              echo "初始化配置文件：将默认配置复制到挂载卷"
              cp /app/config.default.yaml /app/datas/config.yaml
          else
              echo "检测到已有配置文件，跳过初始化"
          fi
          ln -sf /app/datas/config.yaml /app/config.yaml

          MODE=""
          FIRST_ARG="$1"

          normalize_mode() {
              case "$1" in
                  cpa|api|cli-proxy-api|"")
                      echo "cpa"
                      ;;
                  cpap|plus|cli-proxy-api-plus)
                      echo "cpap"
                      ;;
                  *)
                      echo "unknown"
                      ;;
              esac
          }

          if [ -n "$FIRST_ARG" ]; then
              NM=$(normalize_mode "$FIRST_ARG")
              if [ "$NM" != "unknown" ]; then
                  MODE="$NM"
                  shift
              fi
          fi

          if [ -z "$MODE" ] && [ -n "$APP_MODE" ]; then
              NM=$(normalize_mode "$APP_MODE")
              if [ "$NM" != "unknown" ]; then
                  MODE="$NM"
              fi
          fi

          if [ -z "$MODE" ]; then
              MODE="cpa"
          fi

          echo "启动模式: $MODE"

          if [ "$MODE" = "cpap" ]; then
              exec /app/cli-proxy-api-plus "$@"
          else
              exec /app/cli-proxy-api "$@"
          fi
          EOF

          chmod +x entrypoint.sh

          cat > Dockerfile << 'EOF'
          FROM alpine:latest

          WORKDIR /app

          RUN apk add --no-cache ca-certificates tzdata

          ARG TARGETARCH

          COPY bin/${TARGETARCH}/cli-proxy-api /app/cli-proxy-api
          COPY bin/${TARGETARCH}/cli-proxy-api-plus /app/cli-proxy-api-plus
          COPY config.yaml /app/config.default.yaml
          COPY entrypoint.sh /app/entrypoint.sh

          RUN chmod +x /app/cli-proxy-api \
              && chmod +x /app/cli-proxy-api-plus \
              && chmod +x /app/entrypoint.sh \
              && mkdir -p /app/datas

          EXPOSE 8317

          ENTRYPOINT ["/app/entrypoint.sh"]
          EOF

      ###########################################################################
      # 选择构建架构
      ###########################################################################
      - name: Prepare platforms
        id: platform
        run: |
          arch="${{ inputs.architecture }}"
          if [ -z "$arch" ]; then
            echo "platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          else
            echo "platforms=$arch" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        if: ${{ steps.platform.outputs.platforms != 'linux/amd64' }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      ###########################################################################
      # 生成 config.yaml
      ###########################################################################
      - name: Create config.yaml
        run: |
          set -e
          curl -sSL -o config.yaml "https://github.com/router-for-me/CLIProxyAPI/raw/refs/heads/main/config.example.yaml"
          sed -i \
            -e 's/^host:.*/host: "0.0.0.0"/' \
            -e 's/^\( *\)allow-remote:.*/\1allow-remote: true/' \
            -e 's/^\( *\)secret-key:.*/\1secret-key: "$2a$10$4tlNu.z8fp4XI4KDts1vTOF0pQcslHKp785KS5NQRTBKfb9sffPs."/' \
            -e 's#^\( *\)auth-dir:.*#\1auth-dir: "/app/datas/cli-proxy-api"#' \
            config.yaml

      ###########################################################################
      # 准备 bin 目录
      ###########################################################################
      - name: Prepare bin directory
        run: mkdir -p bin/amd64 bin/arm64

      ###########################################################################
      # 下载 CLIProxyAPIPlus
      ###########################################################################
      - name: Download CLIProxyAPIPlus
        id: cpa_plus
        run: |
          set -e
          REPO="${{ env.CPA_PLUS_REPO }}"
          VERSION="${{ inputs.cpa_plus_version }}"

          if [ -z "$VERSION" ]; then
            echo "未指定 CLIProxyAPIPlus 版本，获取最新 release"
            release=$(curl -s "https://api.github.com/repos/$REPO/releases/latest")
          else
            echo "指定 CLIProxyAPIPlus 版本: $VERSION"
            release=$(curl -s "https://api.github.com/repos/$REPO/releases/tags/$VERSION")
            if echo "$release" | grep -q '"message": "Not Found"'; then
              echo "源仓库 $REPO 中不存在 tag: $VERSION"
              exit 1
            fi
          fi

          TAG=$(echo "$release" | jq -r '.tag_name')
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "无法从 CLIProxyAPIPlus release 中解析 tag_name"
            echo "$release"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

          for arch in amd64 arm64; do
            asset=$(echo "$release" | jq -r ".assets[] | select(.name | contains(\"_linux_${arch}\")) | .browser_download_url")
            if [ -z "$asset" ] || [ "$asset" = "null" ]; then
              echo "未找到 CLIProxyAPIPlus ${arch} 对应的 linux 资产"
              exit 1
            fi

            file="plus_${arch}.tar.gz"
            curl -sSL -o "$file" "$asset"
            mkdir -p "tmp_plus_${arch}"
            tar -xzf "$file" -C "tmp_plus_${arch}"
            if [ ! -f "tmp_plus_${arch}/cli-proxy-api-plus" ]; then
              echo "解压后未找到 cli-proxy-api-plus (arch=${arch})"
              ls -R "tmp_plus_${arch}" || true
              exit 1
            fi
            cp "tmp_plus_${arch}/cli-proxy-api-plus" "bin/${arch}/cli-proxy-api-plus"
          done

      ###########################################################################
      # 下载 CLIProxyAPI
      ###########################################################################
      - name: Download CLIProxyAPI
        id: cpa
        run: |
          set -e
          REPO="${{ env.CPA_REPO }}"
          VERSION="${{ inputs.cpa_version }}"

          if [ -z "$VERSION" ]; then
            echo "未指定 CLIProxyAPI 版本，获取最新 release"
            release=$(curl -s "https://api.github.com/repos/$REPO/releases/latest")
          else
            echo "指定 CLIProxyAPI 版本: $VERSION"
            release=$(curl -s "https://api.github.com/repos/$REPO/releases/tags/$VERSION")
            if echo "$release" | grep -q '"message": "Not Found"'; then
              echo "源仓库 $REPO 中不存在 tag: $VERSION"
              exit 1
            fi
          fi

          TAG=$(echo "$release" | jq -r '.tag_name')
          if [ -z "$TAG" ] || [ "$TAG" = "null" ]; then
            echo "无法从 CLIProxyAPI release 中解析 tag_name"
            echo "$release"
            exit 1
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT

          for arch in amd64 arm64; do
            asset=$(echo "$release" | jq -r ".assets[] | select(.name | contains(\"_linux_${arch}\")) | .browser_download_url")
            if [ -z "$asset" ] || [ "$asset" = "null" ]; then
              echo "未找到 CLIProxyAPI ${arch} 对应的 linux 资产"
              exit 1
            fi

            file="cpa_${arch}.tar.gz"
            curl -sSL -o "$file" "$asset"
            mkdir -p "tmp_cpa_${arch}"
            tar -xzf "$file" -C "tmp_cpa_${arch}"
            if [ ! -f "tmp_cpa_${arch}/cli-proxy-api" ]; then
              echo "解压后未找到 cli-proxy-api (arch=${arch})"
              ls -R "tmp_cpa_${arch}" || true
              exit 1
            fi
            cp "tmp_cpa_${arch}/cli-proxy-api" "bin/${arch}/cli-proxy-api"
          done

      ###########################################################################
      # 计算最终镜像 TAG
      ###########################################################################
      - name: Decide final image tag
        id: tag
        run: |
          set -e
          CPA_TAG="${{ steps.cpa.outputs.tag }}"
          CPAP_TAG="${{ steps.cpa_plus.outputs.tag }}"

          if [ "$CPA_TAG" = "$CPAP_TAG" ]; then
            FINAL_TAG="$CPA_TAG"
          else
            FINAL_TAG="${CPA_TAG}-cpa_${CPAP_TAG}-cpap"
          fi

          echo "final_tag=$FINAL_TAG" >> $GITHUB_OUTPUT
          echo "最终镜像 TAG: $FINAL_TAG"

      ###########################################################################
      # 构建前检查
      ###########################################################################
      - name: Pre-Build Checks
        run: |
          set -e

          echo "=== 检查 Dockerfile 是否存在 ==="
          if [ ! -f Dockerfile ]; then
            echo "Dockerfile 不存在，生成步骤可能失败"
            exit 1
          fi

          echo "=== 检查 config.yaml 是否存在 ==="
          if [ ! -f config.yaml ]; then
            echo "config.yaml 不存在"
            exit 1
          fi

          echo "=== 检查 bin 目录结构 ==="
          ls -R bin || true

          for arch in amd64 arm64; do
            if [ ! -f "bin/${arch}/cli-proxy-api" ]; then
              echo "缺少二进制文件: bin/${arch}/cli-proxy-api"
              exit 1
            fi
            if [ ! -f "bin/${arch}/cli-proxy-api-plus" ]; then
              echo "缺少二进制文件: bin/${arch}/cli-proxy-api-plus"
              exit 1
            fi
          done

      ###########################################################################
      # 登录 GHCR
      ###########################################################################
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      ###########################################################################
      # 检查 GHCR 中是否已存在对应 tag（单一镜像 cpa）
      ###########################################################################
      - name: Check GHCR tag for cpa
        id: check_cpa
        run: |
          set -e
          IMAGE="${{ github.repository_owner }}/cpa"
          TAG="${{ steps.tag.outputs.final_tag }}"
          STRATEGY="${{ inputs.rebuild_strategy }}"

          echo "检查 GHCR 镜像: $IMAGE:$TAG (策略: $STRATEGY)"

          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/${IMAGE}/manifests/${TAG}")

          if [ "$status" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "GHCR 中已存在镜像: $IMAGE:$TAG"
            if [ "$STRATEGY" = "skip" ]; then
              echo "根据策略 skip，跳过构建"
              echo "skip_build=true" >> $GITHUB_OUTPUT
            else
              echo "根据策略 force，继续构建并覆盖"
              echo "skip_build=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "GHCR 中不存在镜像: $IMAGE:$TAG，将进行构建"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      ###########################################################################
      # 构建并推送 cpa（单一镜像）
      ###########################################################################
      - name: Build and push cpa
        if: ${{ steps.check_cpa.outputs.skip_build == 'false' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ steps.platform.outputs.platforms }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/cpa:${{ steps.tag.outputs.final_tag }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/cpa:latest

      ###########################################################################
      # 构建总结
      ###########################################################################
      - name: Build Summary
        if: ${{ steps.check_cpa.outputs.skip_build == 'true' }}
        run: |
          echo "=============================================================="
          echo "本次构建未执行镜像构建："
          echo "因为策略为 skip 且目标版本已存在。"
          echo "=============================================================="
